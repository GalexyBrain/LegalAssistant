<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Agentic Case Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f14; --panel:#0e1420; --ink:#e7e9ee; --muted:#9aa3b2; --accent:#5aa2ff; --border:rgba(255,255,255,.08)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:radial-gradient(1200px 800px at 80% -10%, rgba(90,162,255,.12), transparent 60%),
                       radial-gradient(900px 600px at -10% 110%, rgba(90,162,255,.08), transparent 60%), var(--bg);
      color:var(--ink);font:15px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial
    }
    .wrap{max-width:1100px;margin:0 auto;padding:28px}
    .topbar{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{display:grid;place-items:center;width:34px;height:34px;border-radius:10px;
      background:linear-gradient(135deg, rgba(90,162,255,.9), rgba(90,162,255,.5));color:#0a1020;font-weight:900}
    .pill{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .muted{color:var(--muted)}
    .spacer{flex:1}
    .row{display:grid;grid-template-columns:1fr 340px;gap:18px}
    @media (max-width:1000px){.row{grid-template-columns:1fr}}
    .card{background:color-mix(in sRGB, var(--panel) 92%, transparent);border:1px solid var(--border);border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .pad{padding:16px}
    h2,h3{margin:0 0 10px}
    .chat{height:62vh;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .bubble{max-width:80%;border:1px solid var(--border);border-radius:14px;padding:12px 14px;white-space:pre-wrap;word-wrap:break-word}
    .you{align-self:flex-end;background:color-mix(in sRGB, var(--accent) 20%, transparent);border-color:color-mix(in sRGB, var(--accent) 40%, transparent)}
    .bot{align-self:flex-start;background:rgba(255,255,255,.03)}
    .controls{display:flex;gap:10px;align-items:flex-end}
    textarea.input{flex:1;min-height:96px;max-height:220px;resize:vertical;background:rgba(255,255,255,.04);color:var(--ink);
      border:1px solid var(--border);border-radius:12px;padding:10px;outline:none}
    .input:focus{box-shadow:0 0 0 2px color-mix(in sRGB, var(--accent) 40%, transparent)}
    .btn{display:inline-flex;align-items:center;gap:8px;background:color-mix(in sRGB, var(--accent) 86%, black 0%);color:#0b0f14;
      border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn.ghost{background:rgba(255,255,255,.06);color:var(--ink)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .tiny{font-size:12px}
    ul.cites{margin:8px 0 0 18px;padding:0}
    ul.cites li{color:var(--muted)}
    .section{display:flex;flex-direction:column;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .inputbox, .range{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:10px;color:var(--ink);outline:none}
    .range{padding:6px}
    .hint{color:var(--muted);font-size:12px}
    details.settings{border-top:1px dashed var(--border);padding-top:12px;margin-top:4px}
    details.settings>summary{cursor:pointer;list-style:none}
    details.settings>summary::-webkit-details-marker{display:none}
    .switch{display:flex;align-items:center;gap:10px}
    .trace{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      background:rgba(0,0,0,.35);border-radius:10px;padding:8px;white-space:pre-wrap;max-height:30vh;overflow:auto}
    .rowtop{display:flex;gap:10px;align-items:center;margin-bottom:8px}
    .badge{display:inline-flex;gap:6px;align-items:center;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">AI</div>
        <div>
          <div style="font-weight:700">Agentic Case Chat</div>
          <div class="muted tiny">Preprocessed case-sheets + Gemini. Your PDF/text is sent to the model but never embedded.</div>
        </div>
      </div>
      <div class="spacer"></div>
      <span class="badge tiny">Session: <span id="sid">…</span></span>
    </div>

    <div class="row">
      <!-- Chat -->
      <section class="card pad section">
        <h2>Conversation</h2>
        <div id="chat" class="chat card"></div>
        <div class="controls">
          <textarea id="msg" class="input" placeholder="Ask something… (attach a PDF or paste text in the panel)"></textarea>
          <button id="send" class="btn">➤ Send</button>
          <button id="clear" class="btn ghost">✕ Clear</button>
        </div>
      </section>

      <!-- Controls -->
      <aside class="card pad section">
        <h3>Controls</h3>

        <div class="field">
          <label class="tiny">Streaming</label>
          <label class="switch">
            <input id="stream" type="checkbox" />
            <span class="hint">Live answer. Citations are included only in non-streaming mode.</span>
          </label>
        </div>

        <div class="field">
          <label class="tiny">Attach PDF (optional)</label>
          <input id="file" type="file" accept="application/pdf" class="inputbox" />
          <div class="hint">If streaming is ON and a file is attached, we auto-fallback to non-streaming.</div>
        </div>

        <div class="field">
          <label class="tiny">Paste user doc text (optional)</label>
          <textarea id="raw" class="inputbox" rows="5" placeholder="If no PDF, paste raw text here."></textarea>
        </div>

        <details class="settings">
          <summary class="muted">Advanced</summary>
          <div class="field" style="margin-top:10px">
            <label class="tiny">API Base URL</label>
            <input id="api" class="inputbox" placeholder="http://localhost:5000" />
            <div class="hint">Or pass <code>?api=http://host:5000</code> in the URL.</div>
          </div>
          <div class="field">
            <label class="tiny">top_k: <span id="kval">6</span></label>
            <input id="topk" class="range" type="range" min="2" max="12" value="6" />
          </div>
        </details>

        <div id="traceCard" class="section" style="display:none">
          <h3>Agent Trace</h3>
          <div id="trace" class="trace tiny">No events yet.</div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // ---------- Utilities ----------
    const $ = (id) => document.getElementById(id);

    function uuidv4(){
      if (crypto?.randomUUID) return crypto.randomUUID();
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
        const r=(Math.random()*16)|0, v=c==='x'?r:(r&0x3)|0x8; return v.toString(16);
      });
    }

    function readSSE(stream, onEvent){
      const reader = stream.getReader();
      const decoder = new TextDecoder('utf-8');
      let buf = '';
      return reader.read().then(function process({value, done}){
        if(done){ return; }
        buf += decoder.decode(value, {stream:true});
        let idx;
        while((idx = buf.indexOf('\n\n')) !== -1){
          const raw = buf.slice(0, idx);
          buf = buf.slice(idx+2);
          const lines = raw.split('\n').filter(Boolean);
          for(const l of lines){
            if(!l.startsWith('data:')) continue;
            const payload = l.replace(/^data:\s?/, '');
            try{ onEvent(JSON.parse(payload)); }catch{ onEvent(payload); }
          }
        }
        return reader.read().then(process);
      });
    }

    function el(type, attrs={}, ...children){
      const node = document.createElement(type);
      for(const [k,v] of Object.entries(attrs)){
        if(k === 'class') node.className = v;
        else if(k.startsWith('on') && typeof v === 'function') node.addEventListener(k.slice(2).toLowerCase(), v);
        else node.setAttribute(k, v);
      }
      for(const ch of children){
        if(ch == null) continue;
        if(typeof ch === 'string') node.appendChild(document.createTextNode(ch));
        else node.appendChild(ch);
      }
      return node;
    }

    // --- Markdown helpers (minimal, safe-ish) ---
    function escapeHtml(str){
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // very light sanitizer: remove script tags + inline event handlers
    function sanitizeHtml(html){
      html = html.replace(/<\s*script[^>]*>[\s\S]*?<\s*\/\s*script\s*>/gi, "");
      html = html.replace(/\son\w+\s*=\s*(?:"[^"]*"|'[^']*')/gi, "");
      return html;
    }

    function renderMarkdown(src){
      if(!src) return "";
      let s = escapeHtml(src);

      // Code fences ``` ```
      s = s.replace(/```([\s\S]*?)```/g, (_, code) => {
        return `<pre><code>${code.replace(/</g,"&lt;")}</code></pre>`;
      });

      // Inline code `code`
      s = s.replace(/`([^`]+)`/g, (_, code) => `<code>${code}</code>`);

      // Headings
      s = s.replace(/^(######)\s*(.*)$/gm, "<h6>$2</h6>")
           .replace(/^(#####)\s*(.*)$/gm, "<h5>$2</h5>")
           .replace(/^(####)\s*(.*)$/gm, "<h4>$2</h4>")
           .replace(/^(###)\s*(.*)$/gm, "<h3>$2</h3>")
           .replace(/^(##)\s*(.*)$/gm, "<h2>$2</h2>")
           .replace(/^(#)\s*(.*)$/gm, "<h1>$2</h1>");

      // Blockquotes
      s = s.replace(/^(>\s?.*)$/gm, (m) => `<blockquote>${m.replace(/^>\s?/, "")}</blockquote>`);

      // Bold, italics
      s = s.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>")
           .replace(/__([^_]+)__/g, "<strong>$1</strong>")
           .replace(/\*([^*]+)\*/g, "<em>$1</em>")
           .replace(/_([^_]+)_/g, "<em>$1</em>");

      // Links
      s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, `<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>`);

      // Unordered lists
      s = s.replace(/^(\s*[-*]\s.+(?:\n\s*[-*]\s.+)*)/gm, (block) => {
        const items = block.split(/\n/).map(l => l.replace(/^\s*[-*]\s/, "").trim());
        return `<ul>${items.map(it=>`<li>${it}</li>`).join("")}</ul>`;
      });

      // Ordered lists
      s = s.replace(/^(\s*\d+\.\s.+(?:\n\s*\d+\.\s.+)*)/gm, (block) => {
        const items = block.split(/\n/).map(l => l.replace(/^\s*\d+\.\s/, "").trim());
        return `<ol>${items.map(it=>`<li>${it}</li>`).join("")}</ol>`;
      });

      // Paragraphs (for plain lines not already wrapped)
      s = s.replace(/^(?!<h\d|<ul>|<ol>|<li>|<pre>|<blockquote>|<p>|<\/)(.+)$/gm, "<p>$1</p>");

      return sanitizeHtml(s);
    }

    function pushBubble(role, content, citations){
      const chat = $('chat');
      const isYou = role === 'user';
      const bubble = el('div', {class: 'bubble ' + (isYou?'you':'bot')});

      // render markdown → safe HTML
      const html = renderMarkdown(content || '');
      const body = document.createElement('div');
      body.innerHTML = html;
      bubble.appendChild(body);

      if(!isYou && Array.isArray(citations) && citations.length){
        const ul = el('ul', {class:'cites'});
        for(const c of citations){
          const li = el('li', {}, `${c?.filename || 'source'}${c?.page ? ' p.'+c.page : ''}`);
          ul.appendChild(li);
        }
        bubble.appendChild(ul);
      }
      chat.appendChild(bubble);
      chat.scrollTop = chat.scrollHeight;
    }

    function pushTrace(line){
      const t = $('trace');
      if(t.textContent === 'No events yet.') t.textContent = '';
      t.textContent += (typeof line === 'string' ? line : JSON.stringify(line)) + '\n';
      t.scrollTop = t.scrollHeight;
    }
    function clearTrace(){ $('trace').textContent = 'No events yet.'; }

    // ---------- Boot ----------
    (function init(){
      const url = new URL(window.location.href);
      const apiFromQuery = url.searchParams.get('api');
      const apiStored = localStorage.getItem('api_base');
      const apiDefault = 'http://localhost:5000';
      $('api').value = apiFromQuery || apiStored || apiDefault;

      let sid = localStorage.getItem('agent_session_id');
      if(!sid){ sid = uuidv4(); localStorage.setItem('agent_session_id', sid); }
      $('sid').textContent = sid.slice(0,8);

      $('topk').addEventListener('input', (e)=> $('kval').textContent = e.target.value);
      $('api').addEventListener('change', (e)=> localStorage.setItem('api_base', e.target.value));

      $('stream').addEventListener('change', ()=>{
        const on = $('stream').checked;
        $('traceCard').style.display = on ? 'block' : 'none';
        if(!on) clearTrace();
      });

      $('send').addEventListener('click', send);
      $('clear').addEventListener('click', ()=>{ $('chat').innerHTML=''; clearTrace(); });

      $('msg').addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); send(); }
      });
    })();

    // ---------- API Calls ----------
    async function send(){
      const message = $('msg').value.trim();
      const apiBase = $('api').value.trim() || 'http://localhost:5000';
      const sid = localStorage.getItem('agent_session_id') || uuidv4();
      const topK = parseInt($('topk').value, 10) || 6;
      const useStream = $('stream').checked;
      const file = $('file').files?.[0] || null;
      const rawText = $('raw').value.trim();

      if(!message && !file && !rawText){
        alert('Type a message, attach a PDF, or paste raw text.'); return;
      }

      // UI state
      $('send').disabled = true;
      const prevSendText = $('send').textContent;
      $('send').textContent = '… Sending';
      if(useStream) clearTrace();

      // user bubble
      if(message) pushBubble('user', message);

      try{
        if(useStream && file){
          // Streaming + multipart not ideal → use non-streaming
          await sendNonStreaming(apiBase, sid, message, topK, file, rawText);
        }else if(useStream){
          await sendStreaming(apiBase, sid, message, topK, rawText);
        }else{
          await sendNonStreaming(apiBase, sid, message, topK, file, rawText);
        }
      }catch(err){
        pushBubble('assistant', '⚠️ ' + (err?.message || err));
      }finally{
        $('msg').value = '';
        $('file').value = '';
        $('send').disabled = false;
        $('send').textContent = prevSendText;
      }
    }

    async function sendNonStreaming(apiBase, sid, message, topK, fileOrNull, rawText){
      let res;
      if(fileOrNull){
        const fd = new FormData();
        fd.append('message', message || '(no message)');
        fd.append('session_id', sid);
        fd.append('top_k', String(topK));
        fd.append('user_pdf', fileOrNull);
        res = await fetch(apiBase + '/chat', { method:'POST', body: fd });
      }else{
        res = await fetch(apiBase + '/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            message: message || '(no message)',
            session_id: sid,
            user_doc_text: rawText || undefined,
            top_k: topK
          })
        });
      }
      const data = await handleJSON(res);
      pushBubble('assistant', data?.answer || '(no answer)', data?.citations || []);
    }

    async function sendStreaming(apiBase, sid, message, topK, rawText){
      const res = await fetch(apiBase + '/chat/stream', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ message, session_id: sid, user_doc_text: rawText || undefined, top_k: topK })
      });
      if(!res.ok || !res.body){
        const e = await safeJSON(res);
        throw new Error(e?.error || `HTTP ${res.status}`);
      }

      let finalAnswer = '';
      await readSSE(res.body, (evt)=>{
        pushTrace(evt);
        if(typeof evt === 'object'){
          if(evt.output) finalAnswer = evt.output;
          if(evt.agent_output) finalAnswer = evt.agent_output;
        }else if(typeof evt === 'string'){
          finalAnswer = evt;
        }
      });

      // ❌ No second call to /chat. We keep it single-endpoint in streaming mode.
      pushBubble('assistant', finalAnswer || '(no answer)');
    }

    async function handleJSON(res){
      if(!res.ok){
        const e = await safeJSON(res);
        throw new Error(e?.error || `HTTP ${res.status}`);
      }
      return res.json();
    }
    async function safeJSON(res){ try{return await res.json();}catch{return null;} }
  </script>
</body>
</html>
