<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard · Legal Assistant</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1522; --ink:#e7e9ee; --muted:#9aa3b2; --accent:#5aa2ff; --soft:#1a2233;
      --ok:#56d39b; --warn:#f7c948; --err:#ff6b6b; --border:rgba(255,255,255,.08); --shadow:rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:
        radial-gradient(1100px 700px at 90% -20%, rgba(90,162,255,.12), transparent 60%),
        radial-gradient(900px 600px at -10% 110%, rgba(90,162,255,.08), transparent 60%), var(--bg);
      color:var(--ink); font:15px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }
    a{color:var(--ink); text-decoration:none}
    .shell{max-width:1060px; margin:0 auto; padding:24px}
    .nav{
      position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
      background:linear-gradient(180deg, rgba(11,15,20,.9), rgba(11,15,20,.55));
      border-bottom:1px solid var(--border);
    }
    .nav .row{display:flex; gap:16px; align-items:center; justify-content:space-between; padding:12px 24px}
    .brand{display:flex; gap:10px; align-items:center; font-weight:700}
    .brand .dot{width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 24px var(--accent)}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:1px solid var(--border);
      background:linear-gradient(180deg, #0f1522, #0b0f14); color:var(--ink); border-radius:12px; cursor:pointer;
      box-shadow:0 6px 18px -10px var(--shadow); transition:transform .06s ease, border-color .2s ease, background .2s ease}
    .btn:hover{transform:translateY(-1px); border-color:#20324d}
    .btn.prime{background:linear-gradient(180deg, #1a2742, #0f1a2d); border-color:#2b4166}
    .row{display:flex; gap:16px; flex-wrap:wrap}
    .grid{display:grid; gap:16px}
    .card{
      background:linear-gradient(180deg, var(--panel), #0c1220);
      border:1px solid var(--border); border-radius:16px; padding:18px;
      box-shadow:0 12px 40px -24px var(--shadow);
    }
    .muted{color:var(--muted)}
    input, select{
      width:100%; padding:12px; border-radius:12px; background:#0c1220; color:var(--ink);
      border:1px solid var(--border); outline:none; transition:border-color .2s ease;
    }
    input:focus, select:focus{border-color:#294368}
    .field{display:grid; gap:8px}
    .pill{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#0c1220}
    .list{display:grid; gap:12px}
    .item{display:flex; gap:12px; align-items:center; justify-content:space-between; padding:14px; border:1px solid var(--border); border-radius:12px; background:#0c111b}
    .badge{font-size:12px; padding:4px 8px; border-radius:8px; background:#0f1828; border:1px solid #24334b}
    .footnote{font-size:12px; color:var(--muted)}
    .spacer{height:8px}
    .hidden{display:none}
    .divider{height:1px; background:var(--border); margin:10px 0}
    .toast{
      position:fixed; right:16px; bottom:16px; padding:12px 16px; border-radius:12px; background:#0c111b; border:1px solid var(--border);
      box-shadow:0 10px 30px -20px var(--shadow); color:var(--ink); z-index:9999; display:none;
    }
  </style>
</head>
<body>
  <header class="nav">
    <div class="row">
      <div class="brand"><span class="dot"></span> Legal Assistant</div>
      <div class="row">
        <a class="btn" href="chat.html">AI Assistant</a>
        <a class="btn" href="profile.html">Profile</a>
        <button class="btn" id="logoutBtn">Logout</button>
      </div>
    </div>
  </header>

  <main class="shell">
    <div class="row">
      <!-- CLIENT: Discover Lawyers -->
      <div id="discoverCard" class="card" style="flex:1 1 300px">
        <h2 style="margin:0 0 6px 0">Discover Lawyers</h2>
        <p class="muted">Find verified lawyers. Use your location to see who's nearby.</p>
        <div class="divider"></div>
        <div class="grid" style="grid-template-columns:2fr 1fr auto; align-items:end">
          <div class="field"><label>Search</label><input id="q" placeholder="Name, email, city"/></div>
          <div class="field"><label>Radius (km)</label><input id="radius" type="number" min="1" max="500" value="50"/></div>
          <div class="row">
            <button class="btn" id="useGeo">Use my location</button>
            <button class="btn prime" id="findBtn">Find</button>
          </div>
        </div>
        <div class="spacer"></div>
        <div id="geoInfo" class="footnote">No location yet</div>
        <div class="divider"></div>
        <div id="results" class="list"></div>
      </div>

      <!-- LAWYER: Alternate card -->
      <div id="lawyerInfoCard" class="card hidden" style="flex:1 1 300px">
        <h2 style="margin:0 0 6px 0">Welcome, Lawyer</h2>
        <div class="divider"></div>
        <p class="muted">Clients will contact you directly. Use the Chat panel to view ongoing conversations.</p>
        <div class="row">
          <a class="btn prime" href="chat.html">Open Chat</a>
          <a class="btn" href="profile.html">Update Profile</a>
        </div>
      </div>

      <div class="card" style="flex:1 1 260px">
        <h2 style="margin:0 0 6px 0">Quick Actions</h2>
        <div class="divider"></div>
        <div class="list">
          <a class="item" href="chat.html">
            <div>
              <b>Open Chat</b>
              <div class="footnote">AI Assistant & direct messaging.</div>
            </div>
            <span class="badge">Chat</span>
          </a>
          <a class="item" href="profile.html">
            <div><b>Update your profile</b><div class="footnote">Location helps matching nearby lawyers (for clients).</div></div>
            <span class="badge">Profile</span>
          </a>
          <button class="item btn" id="lawyerCheck">
            <div><b>Lawyer portal check</b><div class="footnote">Verifies access (lawyers only)</div></div>
            <span class="badge">Test</span>
          </button>
        </div>
      </div>
    </div>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    const API_BASE = location.protocol === 'file:' ? 'http://localhost:5000' : '';
    const toast = (msg, kind='') => { const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; t.style.borderColor = kind==='err' ? '#6b2b2b' : '#2b4166'; setTimeout(()=>t.style.display='none', 3000); };
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if(!token || !user) location.href = 'auth.html';

    document.getElementById('logoutBtn').onclick = ()=>{ localStorage.removeItem('token'); localStorage.removeItem('user'); location.href='auth.html'; };

    const headers = { 'Authorization': 'Bearer ' + token };

    // Role-based UI: hide "Discover Lawyers" for lawyers
    const discoverCard = document.getElementById('discoverCard');
    const lawyerInfoCard = document.getElementById('lawyerInfoCard');
    if (user.role === 'lawyer') {
      discoverCard.classList.add('hidden');
      lawyerInfoCard.classList.remove('hidden');
    }

    // Client-only features
    const state = { lat:null, lon:null };
    const geoInfo = document.getElementById('geoInfo');
    const useGeoBtn = document.getElementById('useGeo');
    const findBtn = document.getElementById('findBtn');
    const results = document.getElementById('results');

    if (user.role !== 'lawyer') {
      useGeoBtn.onclick = async ()=>{
        try{ const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res, rej, {enableHighAccuracy:true, timeout:8000}));
          state.lat = pos.coords.latitude; state.lon = pos.coords.longitude;
          geoInfo.textContent = `Lat: ${state.lat.toFixed(5)}, Lon: ${state.lon.toFixed(5)}`;
          toast('Location captured');
        }catch(e){ toast('Could not get location', 'err'); }
      };

      async function findLawyers(){
        const q = document.getElementById('q').value.trim();
        const radius_km = parseFloat(document.getElementById('radius').value || '50');
        const params = new URLSearchParams();
        if(q) params.set('q', q);
        if(state.lat && state.lon) { params.set('lat', state.lat); params.set('lon', state.lon); params.set('radius_km', radius_km); }
        try{
          const r = await fetch(API_BASE + '/lawyers?' + params.toString(), { headers });
          const j = await r.json();
          if(!r.ok) throw new Error(j.error || 'Failed to fetch lawyers');
          results.innerHTML='';
          if(!j.lawyers.length) { results.innerHTML = '<div class="muted">No matches yet.</div>'; return; }
          for(const L of j.lawyers){
            const div = document.createElement('div'); div.className='item';
            const dist = L.distance_km!=null ? `<span class="pill">${L.distance_km} km</span>` : '';
            div.innerHTML = `
              <div>
                <div><b>${L.email}</b></div>
                <div class="footnote">${L.location_name || 'No location'} ${dist? '· '+dist: ''}</div>
              </div>
              <div class="row">
                <a class="btn prime" href="chat.html?with_user_id=${L.id}">Connect</a>
              </div>`;
            results.appendChild(div);
          }
        }catch(e){ toast(e.message, 'err'); }
      }
      findBtn.onclick = findLawyers;
      findLawyers(); // initial load
    }

    // Lawyer portal check (works for anyone, only succeeds for lawyer)
    document.getElementById('lawyerCheck').onclick = async ()=>{
      try{ const r = await fetch(API_BASE + '/lawyer/dashboard', { headers }); const j = await r.json(); if(!r.ok) throw new Error(j.error || 'Forbidden'); toast(j.message || 'OK'); }
      catch(e){ toast(e.message, 'err'); }
    };
  </script>
</body>
</html>
