<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign In · Legal Assistant</title>
  <meta name="color-scheme" content="dark light" />
  
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1522; --ink:#e7e9ee; --muted:#9aa3b2; --accent:#5aa2ff; --soft:#1a2233;
      --ok:#56d39b; --warn:#f7c948; --err:#ff6b6b; --border:rgba(255,255,255,.08); --shadow:rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:
        radial-gradient(1100px 700px at 90% -20%, rgba(90,162,255,.12), transparent 60%),
        radial-gradient(900px 600px at -10% 110%, rgba(90,162,255,.08), transparent 60%), var(--bg);
      color:var(--ink); font:15px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }
    a{color:var(--ink); text-decoration:none}
    .shell{max-width:1060px; margin:0 auto; padding:24px}
    .nav{
      position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
      background:linear-gradient(180deg, rgba(11,15,20,.9), rgba(11,15,20,.55));
      border-bottom:1px solid var(--border);
    }
    .nav .row{display:flex; gap:16px; align-items:center; justify-content:space-between; padding:12px 24px}
    .brand{display:flex; gap:10px; align-items:center; font-weight:700}
    .brand .dot{width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 24px var(--accent)}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:1px solid var(--border);
      background:linear-gradient(180deg, #0f1522, #0b0f14); color:var(--ink); border-radius:12px; cursor:pointer;
      box-shadow:0 6px 18px -10px var(--shadow); transition:transform .06s ease, border-color .2s ease, background .2s ease}
    .btn:hover{transform:translateY(-1px); border-color:#20324d}
    .btn.prime{background:linear-gradient(180deg, #1a2742, #0f1a2d); border-color:#2b4166}
    .btn.ok{background:linear-gradient(180deg, #113524, #0c2419); border-color:#1f5b3d}
    .btn.err{background:linear-gradient(180deg, #3a1414, #2a0f0f); border-color:#6b2b2b}
    .row{display:flex; gap:16px; flex-wrap:wrap}
    .grid{display:grid; gap:16px}
    .hero{display:grid; grid-template-columns:1.1fr .9fr; gap:24px; align-items:center; margin-top:24px}
    .card{
      background:linear-gradient(180deg, var(--panel), #0c1220);
      border:1px solid var(--border); border-radius:16px; padding:18px;
      box-shadow:0 12px 40px -24px var(--shadow);
    }
    .muted{color:var(--muted)}
    input, select, textarea{
      width:100%; padding:12px 12px; border-radius:12px; background:#0c1220; color:var(--ink);
      border:1px solid var(--border); outline:none; transition:border-color .2s ease;
    }
    input:focus, select:focus, textarea:focus{border-color:#294368}
    .field{display:grid; gap:8px}
    .pill{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#0c1220}
    .list{display:grid; gap:12px}
    .item{display:flex; gap:12px; align-items:center; justify-content:space-between; padding:14px; border:1px solid var(--border); border-radius:12px; background:#0c111b}
    .badge{font-size:12px; padding:4px 8px; border-radius:8px; background:#0f1828; border:1px solid #24334b}
    .right{margin-left:auto}
    .footnote{font-size:12px; color:var(--muted)}
    .spacer{height:8px}
    .hidden{display:none}
    .divider{height:1px; background:var(--border); margin:10px 0}
    .toast{
      position:fixed; right:16px; bottom:16px; padding:12px 16px; border-radius:12px; background:#0c111b; border:1px solid var(--border);
      box-shadow:0 10px 30px -20px var(--shadow); color:var(--ink); z-index:9999; display:none;
    }
    .chat{
      height:62vh; overflow:auto; padding:12px; border:1px solid var(--border); border-radius:12px; background:#0c111b
    }
    .bubble{max-width:74%; padding:10px 12px; margin:8px 0; border-radius:14px; line-height:1.4}
    .bubble.me{background:#15223a; border:1px solid #2b4166; margin-left:auto}
    .bubble.other{background:#112016; border:1px solid #274a35}
    .bubble.ai{background:#161a24; border:1px solid #2b3244}
    .toolbar{display:flex; gap:10px; align-items:center}
    .toolbar input[type=file]{display:none}
    .file-pill{font-size:12px; padding:6px 10px; border:1px dashed #294368; border-radius:999px; background:#10182a}
    .tabs{display:flex; gap:8px; margin-bottom:8px}
    .tabs .btn.active{border-color:#2b4166; background:#122039}
    .kv{display:grid; grid-template-columns:140px 1fr; gap:8px}
    .center{display:flex; align-items:center; justify-content:center}
  </style>

</head>
<body>
  <header class="nav">
    <div class="row">
      <div class="brand"><span class="dot"></span> Legal Assistant</div>
      <div class="row">
        <a class="btn" href="index.html">Home</a>
      </div>
    </div>
  </header>

  <main class="shell">
    <div class="card" style="max-width:680px; margin:0 auto">
      <div class="tabs">
        <button id="tabLogin" class="btn active">Sign In</button>
        <button id="tabSignup" class="btn">Create Account</button>
      </div>

      <div id="loginPane">
        <div class="grid" style="grid-template-columns:1fr; gap:12px">
          <div class="field"><label>Email</label><input id="loginEmail" type="email" placeholder="you@example.com" autocomplete="email"/></div>
          <div class="field"><label>Password</label><input id="loginPass" type="password" placeholder="••••••••" autocomplete="current-password"/></div>
          <div class="row">
            <button id="loginBtn" class="btn prime">Sign In</button>
          </div>
        </div>
      </div>

      <div id="signupPane" class="hidden">
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
          <div class="field" style="grid-column:1 / -1"><label>Email</label><input id="regEmail" type="email" placeholder="you@example.com" autocomplete="email"/></div>
          <div class="field"><label>Password</label><input id="regPass" type="password" placeholder="Choose a strong password" autocomplete="new-password"/></div>
          <div class="field">
            <label>Role</label>
            <select id="regRole">
              <option value="client">Client</option>
              <option value="lawyer">Lawyer</option>
            </select>
          </div>
          <div class="field" style="grid-column:1 / -1"><label>Location name (optional)</label><input id="locName" placeholder="e.g., Bangalore, Koramangala"/></div>
          <div class="row">
            <button id="useGeo" class="btn">Use my location</button>
            <span id="geoInfo" class="pill muted">No location yet</span>
            <span id="geoData" class="hidden"></span>
          </div>
          <div class="row" style="grid-column:1 / -1">
            <button id="signupBtn" class="btn prime">Create Account</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="footnote">By signing in, you agree to keep it classy and lawful.</div>
    </div>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    const API_BASE = location.protocol === 'file:' ? 'http://localhost:5000' : '';

    const toast = (msg, kind='') => { 
      const t = document.getElementById('toast'); 
      t.textContent = msg; 
      t.style.display='block'; 
      t.style.borderColor = kind==='err' ? '#6b2b2b' : '#2b4166';
      setTimeout(()=>t.style.display='none', 3000);
    };

    // Tabs
    const tabLogin = document.getElementById('tabLogin');
    const tabSignup = document.getElementById('tabSignup');
    const loginPane = document.getElementById('loginPane');
    const signupPane = document.getElementById('signupPane');

    const activate = (pane) => {
      if(pane==='login'){ tabLogin.classList.add('active'); tabSignup.classList.remove('active'); loginPane.classList.remove('hidden'); signupPane.classList.add('hidden'); }
      else { tabSignup.classList.add('active'); tabLogin.classList.remove('active'); signupPane.classList.remove('hidden'); loginPane.classList.add('hidden'); }
    };
    tabLogin.onclick = ()=>activate('login');
    tabSignup.onclick = ()=>activate('signup');
    if (location.hash === '#signup') activate('signup');

    // Geolocation button (kept as-is; we add better messaging)
    document.getElementById('useGeo').onclick = async () => {
      try{
        if (!navigator.geolocation) throw new Error('Geolocation not supported in this browser.');
        const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res, rej, {enableHighAccuracy:true, timeout:12000, maximumAge:0}));
        const {latitude, longitude} = pos.coords;
        document.getElementById('geoData').textContent = JSON.stringify({lat:latitude, lon:longitude, source:'geolocation'});
        document.getElementById('geoInfo').textContent = `Lat: ${latitude.toFixed(5)}, Lon: ${longitude.toFixed(5)}`;
        toast('Location captured');
      }catch(e){ 
        // Friendly hint when page is not secure or permission denied
        const msg = (''+ (e && e.message || e)).toLowerCase().includes('secure') 
          ? 'Open via http://localhost or https:// (file:// cannot use geolocation)'
          : 'Could not get location. Allow permission or enter a place name.';
        toast(msg, 'err'); 
      }
    };

    // --- Geocode Location Name -> coords (fallback when geolocation not used/allowed) ---
    async function geocodeLocationName(q){
      // Nominatim (OpenStreetMap). Keep it simple; handle common errors.
      const url = 'https://nominatim.openstreetmap.org/search?format=jsonv2&q=' + encodeURIComponent(q);
      const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if(!r.ok) throw new Error('Geocoding failed. Try a more specific place name.');
      const arr = await r.json();
      if(!Array.isArray(arr) || arr.length === 0) throw new Error('Place not found. Use "Area, City" (e.g., "Koramangala, Bengaluru").');
      const best = arr[0];
      const lat = parseFloat(best.lat), lon = parseFloat(best.lon);
      if(Number.isNaN(lat) || Number.isNaN(lon)) throw new Error('Invalid coordinates from geocoder.');
      return { lat, lon };
    }

    function setCoordsUI(lat, lon, source=''){
      document.getElementById('geoData').textContent = JSON.stringify({lat, lon, source});
      document.getElementById('geoInfo').textContent = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`;
    }

    // Auto-geocode when user blurs the location text field (nice UX + ensures coords exist)
    document.getElementById('locName').addEventListener('blur', async (e)=>{
      const q = (e.target.value || '').trim();
      if (!q) return;
      // If we already have coordinates from geolocation, skip auto geocode
      try{
        const geo = document.getElementById('geoData').textContent;
        if (geo) {
          const g = JSON.parse(geo);
          if (typeof g.lat === 'number' && typeof g.lon === 'number') return;
        }
      }catch(_){}
      try{
        const { lat, lon } = await geocodeLocationName(q);
        setCoordsUI(lat, lon, 'geocode');
      }catch(err){
        // Don’t toast on blur unless user typed something—still show so they know
        toast(err.message || 'Could not resolve that place name.', 'err');
      }
    });

    // Login
    document.getElementById('loginBtn').onclick = async () => {
      const email = document.getElementById('loginEmail').value.trim().toLowerCase();
      const password = document.getElementById('loginPass').value;
      if(!email || !password) return toast('Email and password required', 'err');
      try{
        const r = await fetch(API_BASE + '/auth/login', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({email, password})});
        let j; try { j = await r.json(); } catch { j = { error: 'Bad response' }; }
        if(!r.ok) throw new Error(j.error || 'Login failed');
        localStorage.setItem('token', j.token);
        localStorage.setItem('user', JSON.stringify(j.user));
        location.href = 'dashboard.html';
      }catch(e){ toast(e.message, 'err'); }
    };

    // Ensure we have coordinates: prefer geolocation; otherwise force geocoding of Location name.
    async function ensureCoordinatesOrFail(){
      // 1) If geoData already has coords, use them.
      try{
        const geo = document.getElementById('geoData').textContent;
        if (geo) {
          const g = JSON.parse(geo);
          if (g && typeof g.lat === 'number' && typeof g.lon === 'number') {
            return { lat: g.lat, lon: g.lon };
          }
        }
      }catch(_){}

      // 2) Otherwise require Location name and geocode it.
      const location_name = (document.getElementById('locName').value || '').trim();
      if (!location_name) {
        throw new Error('Location required: click "Use my location" or type a place name.');
      }
      const { lat, lon } = await geocodeLocationName(location_name);
      setCoordsUI(lat, lon, 'geocode'); // reflect in UI
      return { lat, lon };
    }

    // Signup
    document.getElementById('signupBtn').onclick = async () => {
      const email = document.getElementById('regEmail').value.trim().toLowerCase();
      const password = document.getElementById('regPass').value;
      const role = document.getElementById('regRole').value;
      const location_name = (document.getElementById('locName').value || '').trim() || null;

      if(!email || !password || !role) return toast('Fill all required fields', 'err');

      // LOCATION IS MANDATORY: ensures we send lat/lon (from geolocation or geocoded name)
      let location_lat = null, location_lon = null;
      try{
        const coords = await ensureCoordinatesOrFail();
        location_lat = coords.lat; location_lon = coords.lon;
      }catch(e){
        toast(e.message || 'Location is required.', 'err');
        return;
      }

      try{
        const r = await fetch(API_BASE + '/auth/register', {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({email, password, role, location_name, location_lat, location_lon})
        });
        let j; try { j = await r.json(); } catch { j = { error: 'Bad response' }; }
        if(!r.ok) throw new Error(j.error || 'Signup failed');
        localStorage.setItem('token', j.token);
        localStorage.setItem('user', JSON.stringify(j.user));
        location.href = 'dashboard.html';
      }catch(e){ toast(e.message, 'err'); }
    };
  </script>
</body>
</html>
